<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ディスカッション切り口提案AI（女性技術者 × 未来の職場づくり）</title>
<style>
  :root{
    --bg:#0f1220; --panel:#16192b; --ink:#f3f5ff; --muted:#a8b0d8; --accent:#6ee7b7; --accent-2:#8ab4ff;
    --danger:#ff6b6b; --warn:#ffd166; --ok:#6ee7b7; --divider:#282b4a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0d1020 0%,#111432 100%);color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",Meiryo,Arial,sans-serif;}
  .wrap{max-width:1100px;margin:auto;padding:24px}
  header{display:flex;gap:14px;align-items:center;margin-bottom:18px}
  .logo{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#6ee7b7,#8ab4ff);box-shadow:0 8px 24px rgba(110,231,183,.25);display:grid;place-items:center;font-weight:900;color:#0b1020}
  .title h1{font-size:20px;margin:0 0 4px 0}
  .title small{color:var(--muted)}
  .panel{background:var(--panel);border:1px solid var(--divider);border-radius:16px;padding:18px}
  .grid{display:grid;gap:12px}
  .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:960px){.grid.cols-3,.grid.cols-4{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr}}
  .card{background:#12152a;border:1px solid var(--divider);border-radius:12px;padding:14px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="password"],select,textarea{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--divider);background:#0e1123;color:#fff;outline:none
  }
  textarea{min-height:92px;resize:vertical}
  #context{min-height:240px;font-size:15px;line-height:1.5}
  .btn{appearance:none;border:none;border-radius:999px;padding:10px 18px;font-weight:700;color:#0b1020;background:var(--accent);cursor:pointer}
  .btn.secondary{background:#2a2e53;color:var(--ink);border:1px solid var(--divider)}
  .btn.ghost{background:transparent;border:1px solid var(--divider);color:var(--ink)}
  .btn.warn{background:var(--warn);color:#0b1020}
  .btn.danger{background:var(--danger);color:white}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .chip{display:inline-flex;gap:6px;align-items:center;background:#1a1d36;border:1px solid var(--divider);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px}
  .hint{font-size:13px;color:var(--muted)}
  .divider{height:1px;background:var(--divider);margin:14px 0}
  .step{display:flex;gap:8px;align-items:center}
  .dot{width:10px;height:10px;border-radius:999px;background:#2a2e53;border:1px solid var(--divider)}
  .dot.active{background:var(--accent)}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0c0f1c;border:1px solid var(--divider);border-radius:6px;padding:3px 6px}
  .tag{font-size:12px;color:#b2bcff}
  .big{font-size:22px;font-weight:800;line-height:1.35}
  .toast{position:fixed;right:18px;bottom:18px;background:#10132a;border:1px solid var(--divider);color:var(--ink);padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);display:none}
  .spinner{width:18px;height:18px;border-radius:50%;border:3px solid #2c315b;border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(9,12,26,.55);backdrop-filter:blur(2px);z-index:50}
  .overlay .panel{max-width:560px}
  .final{font-size:18px;line-height:1.7}
  .final h2{font-size:28px;margin:8px 0 6px}
  .final h3{margin:16px 0 8px}
  .ok-banner{background:linear-gradient(135deg,#6ee7b780,#8ab4ff80);border:1px solid #6ee7b73a;padding:14px;border-radius:14px}
  .small{font-size:12px}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  .checkbox-card{display:flex;gap:10px;align-items:flex-start}
  .checkbox-card input{margin-top:4px}
  .danger-text{color:#ff9b9b}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">AI</div>
    <div class="title">
      <h1>ディスカッション切り口提案AI（女性技術者 × 未来の職場づくり）</h1>
      <!-- <small class="muted">1ファイル完結版：HTML + CSS + JS（Gemini API 使用）。APIキーはブラウザ内のみで使用し保存しない。</small> -->
    </div>
  </header>

  <!-- Stepper -->
  <div class="row" style="margin-bottom:10px">
    <div class="step"><span class="dot" id="dot-1"></span><span class="hint">準備</span></div>
    <div class="step"><span class="dot" id="dot-2"></span><span class="hint">大テーマの提示</span></div>
    <div class="step"><span class="dot" id="dot-3"></span><span class="hint">5件選択</span></div>
    <div class="step"><span class="dot" id="dot-4"></span><span class="hint">小テーマ生成</span></div>
    <div class="step"><span class="dot" id="dot-5"></span><span class="hint">最終表示</span></div>
  </div>

  <!-- SETUP -->
  <section id="view-setup" class="panel">
    <h2 style="margin:0 0 8px 0">0) セットアップ</h2>
    <div class="grid cols-2">
      <div class="card">
        <label class="hint">Gemini API Key（ブラウザのみで使用・保存しない）</label>
        <input id="apiKey" type="password" placeholder="AIza...（推奨：プロキシ経由やテスト用キー）" />
        <div class="hint" style="margin-top:8px">※ クライアント側でのキー利用は露出リスクがあるため、本番は軽量プロキシを推奨。</div>
      </div>
      <div class="card">
        <label class="hint">任意の文脈（参加者構成・時間・直近課題など）</label>
        <textarea id="context" placeholder="例：参加者15名（研究職中心）／持ち時間60分／直近は会議の発言偏りと評価の可視化が課題。期待：小さな実験2件を合意。"></textarea>
      </div>
    </div>
    <div class="divider"></div>
    <div class="row">
      <button class="btn" id="btnStart"><span class="spinner sr-only" id="spinStart"></span> スタート</button>
      <span class="hint">フロー：<span class="kbd">Start</span>→最初の言葉＋10大テーマ→5件選択→小テーマ生成→OKで最終画面。</span>
    </div>
  </section>

  <!-- OPENING + THEMES -->
  <section id="view-themes" class="panel" style="display:none">
    <div class="big" id="openingText">…</div>
    <div class="divider"></div>
    <div class="row" style="justify-content:space-between">
      <h2 style="margin:0">1) 大テーマ（10件）から<strong>5つ</strong>選んでください</h2>
      <div class="chip">選択 <span id="selCount">0</span>/5</div>
    </div>
    <div class="grid cols-2" id="themesList"></div>
    <div class="divider"></div>
    <div class="row">
      <button class="btn secondary" id="btnBackSetup">戻る</button>
      <!-- ★追加：大テーマの再提案ボタン -->
      <button class="btn ghost" id="btnRegenThemes">
        <span class="spinner sr-only" id="spinRegenThemes"></span> 大テーマの再提案
      </button>
      <button class="btn" id="btnNextDetails" disabled>
        <span class="spinner sr-only" id="spinNext"></span> 小テーマを生成する
      </button>
    </div>
  </section>

  <!-- DETAILS -->
  <section id="view-details" class="panel" style="display:none">
    <h2 style="margin:0 0 8px 0">2) 選択した5つの大テーマに対する小テーマ案（各5件）</h2>
    <div class="grid cols-2" id="detailsList"></div>
    <div class="divider"></div>
    <div class="row">
      <button class="btn secondary" id="btnReselect">大テーマの再選択</button>
      <button class="btn ghost" id="btnRegen"><span class="spinner sr-only" id="spinRegen"></span> 小テーマの再提案</button>
      <button class="btn" id="btnOK">OK（最終表示へ）</button>
    </div>
  </section>

  <!-- FINAL -->
  <section id="view-final" class="panel" style="display:none">
    <div class="ok-banner">
      <div class="big">3) 最終表示</div>
      <!-- <div class="hint">この内容で会合を開始できる。必要なら小テーマ再提案か大テーマ再選択で戻れる。</div> -->
    </div>
    <div class="final" id="finalRender" style="margin-top:12px"></div>
    <div class="divider"></div>
    <div class="row">
      <button class="btn secondary" id="btnRegen2">小テーマの再提案</button>
      <button class="btn warn" id="btnReselect2">大テーマの再選択</button>
      <button class="btn danger" id="btnReset">最初からやり直す</button>
    </div>
  </section>
</div>

<!-- Loading overlay -->
<div class="overlay" id="overlay">
  <div class="panel">
    <div class="row" style="gap:12px"><div class="spinner"></div><div>Gemini API に問い合わせ中…</div></div>
    <div class="hint" style="margin-top:8px">失敗する場合：APIキー・レート制限・ネットワークをご確認ください。</div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/** ====== 定数（モデル/創造性は固定・非表示） ====== **/
const DEFAULT_MODEL = "gemini-2.0-flash";
const DEFAULT_TEMP  = 0.7;

/** ====== 状態 ====== **/
let STATE = {
  apiKey: "", model: DEFAULT_MODEL, temp: DEFAULT_TEMP, context: "",
  opening: "",
  themes10: [],          // [{id,title,aim,tags}]
  selected5: [],         // indices
  details: [],           // [{bigTitle, subthemes:[{title, one_liner} x5]} x5]
};
const qs = (s)=>document.querySelector(s);
const qsa = (s)=>Array.from(document.querySelectorAll(s));
const show = (id)=>qs(id).style.display="";
const hide = (id)=>qs(id).style.display="none";
const overlay = (b)=>{qs("#overlay").style.display = b ? "grid":"none"};
const toast = (msg, ok=false)=>{const t=qs("#toast"); t.textContent=msg; t.style.display="block"; t.style.borderColor= ok?"#2fd39a": "var(--divider)"; setTimeout(()=>t.style.display="none", 2800)};

/** ====== UI: stepper ====== **/
function step(i){
  for(let k=1;k<=5;k++){ const d=qs(`#dot-${k}`); if(!d) continue; d.classList.toggle('active', k<=i);}
}

/** ====== Gemini API 呼び出し（REST） ====== **/
async function callGeminiJSON({apiKey, model, temperature, systemText, userText}){
  const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;
  const body = {
    system_instruction: { parts: [{ text: systemText }] },
    generationConfig: { temperature: Number(temperature)||DEFAULT_TEMP, response_mime_type: "application/json" },
    contents: [{ role:"user", parts:[{ text: userText }]}]
  };
  const res = await fetch(endpoint, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
  if(!res.ok){ const txt=await res.text(); throw new Error(`HTTP ${res.status}: ${txt}`) }
  const data = await res.json();
  const text = (data?.candidates?.[0]?.content?.parts||[])
    .map(p=>p.text||"").join("").trim();
  const jsonText = extractJSON(text);
  try{ return JSON.parse(jsonText) }catch(e){ throw new Error("JSON 解析に失敗しました: "+e.message+"\n---\n"+text) }
}
function extractJSON(s){
  const start = s.indexOf("{"); const end = s.lastIndexOf("}");
  if(start>=0 && end>start) return s.slice(start, end+1);
  return s;
}

/** ====== プロンプト ====== **/
const SYSTEM_CORE = `
あなたは「議論起点ジェネレータAI」である。女性技術者が主役の会合で、冒頭に良質な切り口を提示する役割のみを担う。
原則：心理的安全性、偏り回避、行動可能性。出力は厳密なJSONのみ。`;

function promptOpeningAndTen(context){
  return `
次の要件でJSONを生成せよ。厳守：コードフェンス禁止・JSON以外の文字禁止。
文脈: ${context || "汎用（参加者は女性技術者、時間60-90分）"}

出力JSONスキーマ:
{
  "opening": "初回の短い導入メッセージ（100字以内、断定調）",
  "themes": [
    {"id":"T1","title":"大テーマ名","aim":"1行のねらい","tags":["制度|運用|文化|会議|評価|キャリア|育成|働き方|情報|テック から2-3つ"]},
    ... 合計10件（重複なし・軸が被りすぎない）
  ]
}`;
}

function promptTenOnly(context){
  return `
次の要件でJSONを生成せよ。厳守：コードフェンス禁止・JSON以外の文字禁止。
文脈: ${context || "汎用（参加者は女性技術者、時間60-90分）"}

出力JSONスキーマ:
{
  "themes": [
    {"id":"T1","title":"大テーマ名","aim":"1行のねらい","tags":["制度|運用|文化|会議|評価|キャリア|育成|働き方|情報|テック から2-3つ"]},
    ... 合計10件（重複なし・軸が被りすぎない）
  ]
}`;
}

function promptFiveDetails(selectedThemes, context){
  const titles = selectedThemes.map((t,i)=>`${String.fromCharCode(65+i)}:${t.title}`).join(" / ");
  return `
次の5つの大テーマに対して、小テーマを各5件ずつ提案せよ。厳守：JSONのみ・コードフェンス不可。
文脈: ${context || "汎用"}
大テーマ: ${titles}

出力JSONスキーマ:
{
  "themes":[
    {
      "bigTitle":"（大テーマ名をそのまま）",
      "subthemes":[
        {"title":"小テーマ名（実装連想しやすい）","one_liner":"1行説明（テンプレ/儀式/可視化/KPI/パイロット等に接続可能）"},
        ... 合計5件
      ]
    },
    ... 合計5件
  ]
}`;
}

/** ====== レンダリング ====== **/
function renderThemes(){
  const host = qs("#themesList"); host.innerHTML = "";
  STATE.selected5 = [];
  qs("#selCount").textContent = "0";
  qs("#btnNextDetails").disabled = true;

  STATE.themes10.forEach((t, idx)=>{
    const card = document.createElement("div"); card.className = "card checkbox-card";
    card.innerHTML = `
      <input type="checkbox" id="th-${idx}" />
      <div>
        <label for="th-${idx}" style="font-weight:700">${escapeHtml(t.title)}</label>
        <div class="muted" style="margin:6px 0">${escapeHtml(t.aim)}</div>
        ${(t.tags||[]).map(tag=>`<span class="chip"><span class="tag">#${escapeHtml(tag)}</span></span>`).join(" ")}
      </div>`;
    host.appendChild(card);
    const chk = card.querySelector("input");
    chk.addEventListener("change", ()=>{
      if(chk.checked){
        if(STATE.selected5.length>=5){ chk.checked=false; toast("選択は最大5件まで", false); return; }
        STATE.selected5.push(idx);
      }else{
        STATE.selected5 = STATE.selected5.filter(i=>i!==idx);
      }
      qs("#selCount").textContent = String(STATE.selected5.length);
      qs("#btnNextDetails").disabled = (STATE.selected5.length!==5);
    });
  });
}

function renderDetails(){
  const host = qs("#detailsList"); host.innerHTML = "";
  STATE.details.forEach((block, bi)=>{
    const col = document.createElement("div"); col.className="card";
    col.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <div style="font-weight:800">${escapeHtml(block.bigTitle)}</div>
        <span class="chip">小テーマ ×5</span>
      </div>
      <div style="margin-top:8px" class="grid">
        ${block.subthemes.map((s,si)=>`
          <div class="panel" style="padding:12px;background:#0f1230;border-color:#262a52">
            <div style="font-weight:700">${String.fromCharCode(65+bi)}-${si+1}. ${escapeHtml(s.title)}</div>
            <div class="hint" style="margin-top:6px">${escapeHtml(s.one_liner||"")}</div>
          </div>
        `).join("")}
      </div>
    `;
    host.appendChild(col);
  });
}

function renderFinal(){
  const host = qs("#finalRender"); host.innerHTML="";
  const selected = STATE.selected5.map(i=>STATE.themes10[i]);
  const html = `
    <h2>Opening</h2>
    <div class="panel">${escapeHtml(STATE.opening)}</div>

    <h3>選定された大テーマ（5件）</h3>
    <div class="grid cols-2">
      ${selected.map((t,i)=>`
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:800">${i+1}. ${escapeHtml(t.title)}</div>
            <span class="chip">#${(t.tags||[]).map(escapeHtml).join(" #")}</span>
          </div>
          <div class="muted" style="margin-top:6px">${escapeHtml(t.aim)}</div>
        </div>`).join("")}
    </div>

    <h3 style="margin-top:14px">小テーマ一覧（各5件）</h3>
    ${STATE.details.map((b,bi)=>`
      <div class="panel" style="margin-top:10px">
        <div style="font-weight:800">${escapeHtml(b.bigTitle)}</div>
        <ol style="margin:8px 0 0 18px">
          ${b.subthemes.map((s,si)=>`<li><strong>${escapeHtml(s.title)}</strong> — <span class="muted">${escapeHtml(s.one_liner||"")}</span></li>`).join("")}
        </ol>
      </div>
    `).join("")}
  `;
  host.innerHTML = html;
}

/** ====== イベント ====== **/
qs("#btnStart").addEventListener("click", async ()=>{
  STATE.apiKey = qs("#apiKey").value.trim();
  if(!STATE.apiKey){ toast("APIキーを入力してください"); return; }
  STATE.model = DEFAULT_MODEL;
  STATE.temp  = DEFAULT_TEMP;
  STATE.context = qs("#context").value.trim();
  step(2);
  qs("#spinStart").classList.remove("sr-only");
  overlay(true);

  try{
    // 1) Opening + 10 themes
    const data = await callGeminiJSON({
      apiKey: STATE.apiKey,
      model: STATE.model,
      temperature: STATE.temp,
      systemText: SYSTEM_CORE,
      userText: promptOpeningAndTen(STATE.context)
    });
    STATE.opening = (data.opening||"").trim();
    STATE.themes10 = Array.isArray(data.themes)? data.themes : [];
    if(STATE.themes10.length!==10) throw new Error("大テーマが10件ではありません。");
    hide("#view-setup"); show("#view-themes"); renderThemes();
    qs("#openingText").textContent = STATE.opening || "ようこそ。未来の職場づくりに向けて、まず大テーマを選びましょう。";
    step(3);
  }catch(err){
    toast("取得に失敗: "+err.message); console.error(err);
  }finally{
    qs("#spinStart").classList.add("sr-only");
    overlay(false);
  }
});

qs("#btnBackSetup").addEventListener("click", ()=>{
  hide("#view-themes"); show("#view-setup"); step(1);
});

/* ★追加：大テーマの再提案 */
qs("#btnRegenThemes").addEventListener("click", async ()=>{
  qs("#spinRegenThemes").classList.remove("sr-only");
  overlay(true);
  try{
    const data = await callGeminiJSON({
      apiKey: STATE.apiKey,
      model: STATE.model,
      temperature: Math.min(1.0, STATE.temp + 0.2), // 変化を少し増やす
      systemText: SYSTEM_CORE,
      userText: promptTenOnly(STATE.context)
    });
    const themes = Array.isArray(data.themes)? data.themes : [];
    if(themes.length!==10) throw new Error("大テーマが10件ではありません。");
    STATE.themes10 = themes;
    renderThemes(); // 選択リセット・カウント更新を内包
    toast("大テーマを再提案しました", true);
  }catch(err){
    toast("大テーマ再提案に失敗: "+err.message);
    console.error(err);
  }finally{
    qs("#spinRegenThemes").classList.add("sr-only");
    overlay(false);
  }
});

qs("#btnNextDetails").addEventListener("click", async ()=>{
  if(STATE.selected5.length!==5){ toast("5件選択してください"); return; }
  const selectedThemes = STATE.selected5.map(i=>STATE.themes10[i]);
  step(4);
  qs("#spinNext").classList.remove("sr-only"); overlay(true);
  try{
    const data = await callGeminiJSON({
      apiKey: STATE.apiKey,
      model: STATE.model,
      temperature: STATE.temp,
      systemText: SYSTEM_CORE,
      userText: promptFiveDetails(selectedThemes, STATE.context)
    });
    STATE.details = Array.isArray(data.themes)? data.themes.map(x=>({bigTitle:x.bigTitle, subthemes:x.subthemes||[]})) : [];
    if(STATE.details.length!==5) throw new Error("小テーマブロックが5件ではありません。");
    hide("#view-themes"); show("#view-details"); renderDetails();
  }catch(err){
    toast("小テーマ生成に失敗: "+err.message); console.error(err);
  }finally{
    qs("#spinNext").classList.add("sr-only"); overlay(false);
  }
});

qs("#btnReselect").addEventListener("click", ()=>{
  hide("#view-details"); show("#view-themes"); step(3);
});
qs("#btnRegen").addEventListener("click", async ()=>{
  const selectedThemes = STATE.selected5.map(i=>STATE.themes10[i]);
  qs("#spinRegen").classList.remove("sr-only"); overlay(true);
  try{
    const data = await callGeminiJSON({
      apiKey: STATE.apiKey, model: STATE.model, temperature: Math.min(1.0,(STATE.temp+0.2)),
      systemText: SYSTEM_CORE,
      userText: promptFiveDetails(selectedThemes, STATE.context)
    });
    STATE.details = Array.isArray(data.themes)? data.themes.map(x=>({bigTitle:x.bigTitle, subthemes:x.subthemes||[]})) : [];
    renderDetails(); toast("小テーマを再提案しました", true);
  }catch(err){ toast("再提案に失敗: "+err.message) }
  finally{ qs("#spinRegen").classList.add("sr-only"); overlay(false); }
});

qs("#btnOK").addEventListener("click", ()=>{
  renderFinal(); hide("#view-details"); show("#view-final"); step(5);
});
qs("#btnRegen2").addEventListener("click", ()=>qs("#btnRegen").click());
qs("#btnReselect2").addEventListener("click", ()=>{ hide("#view-final"); show("#view-themes"); step(3); });
qs("#btnReset").addEventListener("click", ()=>{
  STATE = { apiKey: STATE.apiKey, model: DEFAULT_MODEL, temp: DEFAULT_TEMP, context: "" , opening:"", themes10:[], selected5:[], details:[] };
  show("#view-setup"); hide("#view-themes"); hide("#view-details"); hide("#view-final"); step(1);
});

/** ====== utils ====== **/
function escapeHtml(str){
  return (str??"").toString().replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[s]));
}

/** 初期ステップ表示 */
step(1);
</script>

<!--
変更点:
- モデル/創造性のUIを削除し、DEFAULT_MODEL/DEFAULT_TEMPで固定。
- 最終画面のJSON表示を削除。
- ★追加要件: 大テーマの再提案ボタン（btnRegenThemes）を実装。promptTenOnlyで10大テーマのみ再生成し、UIを更新。
- Gemini API: https://ai.google.dev/api/generate-content
- 本番はサーバープロキシ経由でキー秘匿推奨。
-->
</body>
</html>
