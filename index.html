<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>議論テーマ設計サポート (Live API)</title>
    
    <style>
        :root {
            --primary-color: #007bff;
            --primary-light: #f0f8ff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --gray: #dee2e6;
            --dark-gray: #343a40;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-gray);
            color: var(--dark-gray);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        #app-container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
            position: relative; /* ローディング用 */
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .screen {
            padding: 25px;
            display: none; /* JavaScriptで表示を切り替え */
        }

        .screen.active {
            display: block;
        }

        /* --- スタート画面 --- */
        #screen-start {
            text-align: center;
        }
        
        .welcome-message {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 25px;
        }

        #api-key-input {
            width: calc(100% - 20px);
            padding: 10px;
            font-size: 1rem;
            border: 1px solid var(--gray);
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .api-warning {
            font-size: 0.85rem;
            color: var(--danger-color);
            margin-bottom: 20px;
            text-align: left;
            padding: 10px;
            background-color: #fdf2f2;
            border: 1px solid var(--danger-color);
            border-radius: 4px;
        }

        /* --- ローディング --- */
        .loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.85);
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }
        .loading-overlay.active {
            display: flex;
        }
        .spinner {
            border: 5px solid var(--gray);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        .loading-message {
            margin-top: 15px;
            font-size: 1.1rem;
            color: var(--dark-gray);
            font-weight: 500;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- 大テーマ選択 --- */
        #theme-list {
            list-style-type: none;
            padding: 0;
        }
        .theme-item {
            display: block;
            margin-bottom: 12px;
        }
        .theme-item label {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: var(--primary-light);
            border: 1px solid var(--gray);
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .theme-item label:hover {
            background-color: #e0f0ff;
        }
        .theme-item input[type="checkbox"] {
            margin-right: 15px;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }
        .theme-item input[type="checkbox"]:checked + span {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        #selection-feedback {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }
        #selection-feedback.error {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* --- 小テーマ確認 --- */
        .subtheme-container {
            margin-bottom: 20px;
        }
        .subtheme-container h3 {
            background-color: var(--primary-color);
            color: white;
            padding: 10px 15px;
            margin: 0 0 10px 0;
            border-radius: 4px;
        }
        .subtheme-list {
            list-style-type: disc;
            padding-left: 25px;
        }
        .subtheme-list li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        /* --- 最終結果 --- */
        #final-result-container {
            background-color: var(--primary-light);
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            padding: 20px;
        }

        /* --- ボタン共通 --- */
        .button {
            display: inline-block;
            font-family: var(--font-family);
            font-size: 1rem;
            font-weight: 600;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            transition: background-color 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        .button-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .button-primary:hover {
            background-color: #0056b3;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .button-primary:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .button-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .button-secondary:hover {
            background-color: #5a6268;
        }
        .button-warning {
            background-color: var(--warning-color);
            color: var(--dark-gray);
        }
        .button-warning:hover {
            background-color: #e0a800;
        }
        
        .button-group {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
        }
        .button-group .right {
            margin-left: auto;
        }
        
        /* エラーメッセージ */
        .error-message {
            color: var(--danger-color);
            background-color: #fdf2f2;
            border: 1px solid var(--danger-color);
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            display: none; /* 通常は非表示 */
        }
    </style>
</head>
<body>

    <div id="app-container">
        <div class="loading-overlay" id="loading-overlay">
            <div>
                <div class="spinner"></div>
                <div class="loading-message" id="loading-message">LLMが応答中です...</div>
            </div>
        </div>

        <div id="screen-start" class="screen active">
            <p class="welcome-message">
                参加者の実体験を引き出し、未来に向けた建設的な対話を生み出すためのアジェンダ作成をお手伝いします。
            </p>
            <div class="api-warning">
                <strong>セキュリティ警告:</strong> APIキーはブラウザに保存されません。このウィンドウを閉じると消えます。公開サーバーでは絶対に使用しないでください。
            </div>
            <input type="text" id="api-key-input" placeholder="Google AI Studio APIキーを入力">
            <button id="btn-start" class="button button-primary">スタート</button>
            <div class="error-message" id="start-error"></div>
        </div>

        <div id="screen-themes" class="screen">
            <h2 id="initial-message"></h2>
            <ul id="theme-list"></ul>
            <div id="selection-feedback">5つのテーマを選択してください</div>
            <div class="button-group">
                <button id="btn-confirm-themes" class="button button-primary" disabled>小テーマを生成 (5/5)</button>
            </div>
            <div class="error-message" id="themes-error"></div>
        </div>

        <div id="screen-subthemes" class="screen">
            <h2>生成された小テーマ</h2>
            <p>選択した大テーマに基づき、以下の小テーマ（議論の切り口）を提案します。これでよろしいですか？</p>
            <div id="subtheme-results"></div>
            <div class="button-group">
                <div>
                    <button id="btn-back-to-main" class="button button-secondary">大テーマを再選択</button>
                    <button id="btn-retry-subthemes" class="button button-warning">小テーマを再提案</button>
                </div>
                <button id="btn-confirm-final" class="button button-primary right">OK (最終決定)</button>
            </div>
            <div class="error-message" id="subthemes-error"></div>
        </div>

        <div id="screen-final" class="screen">
            <h2>決定したディスカッション・テーマ</h2>
            <p>以下のテーマで、活発な議論が生まれることを願っています。</p>
            <div id="final-result-container"></div>
            <div class="button-group">
                <button id="btn-restart" class="button button-secondary">最初からやり直す</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM要素の取得 ---
        const screens = document.querySelectorAll('.screen');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingMessage = document.getElementById('loading-message');
        
        const btnStart = document.getElementById('btn-start');
        const apiKeyInput = document.getElementById('api-key-input');
        const startError = document.getElementById('start-error');
        
        const screenThemes = document.getElementById('screen-themes');
        const initialMessageEl = document.getElementById('initial-message');
        const themeListEl = document.getElementById('theme-list');
        const selectionFeedbackEl = document.getElementById('selection-feedback');
        const btnConfirmThemes = document.getElementById('btn-confirm-themes');
        const themesError = document.getElementById('themes-error');

        const screenSubthemes = document.getElementById('screen-subthemes');
        const subthemeResultsEl = document.getElementById('subtheme-results');
        const btnBackToMain = document.getElementById('btn-back-to-main');
        const btnRetrySubthemes = document.getElementById('btn-retry-subthemes');
        const btnConfirmFinal = document.getElementById('btn-confirm-final');
        const subthemesError = document.getElementById('subthemes-error');
        
        const screenFinal = document.getElementById('screen-final');
        const finalResultContainerEl = document.getElementById('final-result-container');
        const btnRestart = document.getElementById('btn-restart');

        // --- 状態管理変数 ---
        let API_KEY = "";
        let selectedMainThemeTitles = []; // 選択された大テーマの「文字列」を保持
        let finalThemesData = {}; // 最終決定したデータを保持
        
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=";

        // --- 関数 ---

        /** 画面を表示する関数 */
        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        /** ローディングを表示/非表示 */
        function showLoading(isLoading, message = "LLMが応答中です...") {
            loadingMessage.textContent = message;
            if (isLoading) {
                loadingOverlay.classList.add('active');
            } else {
                loadingOverlay.classList.remove('active');
            }
        }

        /** エラーメッセージを表示 */
        function showError(element, message) {
            element.textContent = `エラー: ${message}`;
            element.style.display = 'block';
        }

        /** エラーメッセージを非表示 */
        function clearError(...elements) {
            elements.forEach(el => {
                el.textContent = "";
                el.style.display = 'none';
            });
        }
        
        /** Gemini API呼び出し関数 */
        async function callGeminiApi(prompt) {
            if (!API_KEY) {
                throw new Error("APIキーが設定されていません。");
            }
            
            const url = `${API_URL}${API_KEY}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTPエラー: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0) {
                    const textResponse = data.candidates[0].content.parts[0].text;
                    return parseJsonFromText(textResponse);
                } else {
                    throw new Error("LLMからの応答が空か、無効な形式です。");
                }
                
            } catch (error) {
                console.error("API呼び出しエラー:", error);
                throw error; // エラーを呼び出し元に伝播させる
            }
        }
        
        /** LLMの応答テキストからJSONを抽出 */
        function parseJsonFromText(text) {
            // ```json ... ``` または ``` ... ``` ブロックを探す
            const match = text.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
            
            let jsonString = text;
            if (match && match[1]) {
                jsonString = match[1]; // 抽出したJSON文字列
            }
            
            // JSON文字列内のエスケープされた改行などをクリーンアップ
            jsonString = jsonString.replace(/\\n/g, "").replace(/\\/g, "");

            try {
                return JSON.parse(jsonString);
            } catch (e) {
                console.error("JSONのパースに失敗しました:", e, "元テキスト:", text);
                throw new Error("LLMがJSON形式でないデータを返しました。");
            }
        }


        /** チェックボックスの選択状態を監視 */
        function handleCheckboxChange() {
            const checkedBoxes = document.querySelectorAll('#theme-list input[type="checkbox"]:checked');
            const count = checkedBoxes.length;
            
            selectionFeedbackEl.textContent = `(${count}/5) 5つのテーマを選択してください`;
            selectionFeedbackEl.classList.remove('error');

            if (count === 5) {
                btnConfirmThemes.disabled = false;
                btnConfirmThemes.textContent = `小テーマを生成 (5/5)`;
                selectionFeedbackEl.textContent = `5つ選択しました。決定ボタンを押してください。`;
                // 5つ超えて選択できないようにする
                const uncheckedBoxes = document.querySelectorAll('#theme-list input[type="checkbox"]:not(:checked)');
                uncheckedBoxes.forEach(box => box.disabled = true);
            } else {
                btnConfirmThemes.disabled = true;
                btnConfirmThemes.textContent = `小テーマを生成 (${count}/5)`;
                // 制限を解除
                const allBoxes = document.querySelectorAll('#theme-list input[type="checkbox"]');
                allBoxes.forEach(box => box.disabled = false);
            }
        }

        /** ステップ1: スタートボタン押下 */
        async function startProcess() {
            clearError(startError);
            API_KEY = apiKeyInput.value.trim();
            if (!API_KEY) {
                showError(startError, "APIキーを入力してください。");
                return;
            }

            showLoading(true, "大テーマを生成中です...");
            
            const prompt = `
                あなたは「未来の職場づくり」のアジェンダ設計を専門とするコンサルタントです。
                参加者は女性技術者です。
                議論すべき「10個の大テーマ」を提案してください。

                出力は必ず以下のJSON形式の配列だけにしてください。
                ["テーマ1", "テーマ2", "テーマ3", "テーマ4", "テーマ5", "テーマ6", "テーマ7", "テーマ8", "テーマ9", "テーマ10"]
            `;
            
            try {
                const mainThemes = await callGeminiApi(prompt); // ["テーマ1", ...]

                if (!Array.isArray(mainThemes) || mainThemes.length < 10) {
                    throw new Error("LLMが10個のテーマを含む配列を返しませんでした。");
                }
                
                // ステップ2の画面を構築
                initialMessageEl.textContent = "LLMが提案した『10個の大テーマ』です。深く掘り下げたい5つを選んでください。";
                themeListEl.innerHTML = ""; // 初期化
                
                mainThemes.forEach((themeTitle, index) => {
                    const li = document.createElement('li');
                    li.className = 'theme-item';
                    // valueにもテーマ名をそのまま入れる
                    li.innerHTML = `
                        <label>
                            <input type="checkbox" value="${themeTitle}" name="main_theme">
                            <span>${themeTitle}</span>
                        </label>
                    `;
                    themeListEl.appendChild(li);
                });
                
                // イベントリスナーを設定
                const checkboxes = document.querySelectorAll('#theme-list input[type="checkbox"]');
                checkboxes.forEach(box => box.addEventListener('change', handleCheckboxChange));

                // 画面切り替え
                handleCheckboxChange(); // ボタンの状態を初期化
                showScreen('screen-themes');
                
            } catch (error) {
                showError(startError, error.message);
            } finally {
                showLoading(false);
            }
        }

        /** ステップ2: 大テーマ決定ボタン押下 */
        async function confirmMainThemes() {
            clearError(themesError, subthemesError);
            const checkedBoxes = document.querySelectorAll('#theme-list input[type="checkbox"]:checked');
            // value (テーマ名の文字列) の配列を取得
            selectedMainThemeTitles = Array.from(checkedBoxes).map(box => box.value);
            
            if (selectedMainThemeTitles.length !== 5) return; // ガード

            await generateSubthemes(false); // false = 再提案ではない
        }

        /** ステップ3: 小テーマの生成と表示（再提案も含む） */
        async function generateSubthemes(isRetry) {
            showLoading(true, isRetry ? "小テーマを再提案中です..." : "小テーマを生成中です...");
            
            const retryInstruction = isRetry ? "重要：これは再提案の依頼です。前回とは異なる切り口や表現の小テーマを5つずつ提案してください。" : "";
            
            const prompt = `
                あなたは「未来の職場づくり」のアジェンダ設計を専門とするコンサルタントです。
                参加者は女性技術者です。
                以下の5つの大テーマについて、それぞれ議論を深めるための「5つの詳細な小テーマ（議論の切り口）」を提案してください。
                
                ${retryInstruction}

                大テーマ:
                ${selectedMainThemeTitles.map((t, i) => `${i + 1}. ${t}`).join('\n')}

                出力は必ず以下のJSON形式だけにしてください。キーには提供された大テーマの文字列を正確に使用してください。
                {
                  "${selectedMainThemeTitles[0]}": ["小テーマ1", "小テーマ2", "小テーマ3", "小テーマ4", "小テーマ5"],
                  "${selectedMainThemeTitles[1]}": ["小テーマ1", "小テーマ2", "小テーマ3", "小テーマ4", "小テーマ5"],
                  "${selectedMainThemeTitles[2]}": ["小テーマ1", "小テーマ2", "小テーマ3", "小テーマ4", "小テーマ5"],
                  "${selectedMainThemeTitles[3]}": ["小テーマ1", "小テーマ2", "小テーマ3", "小テーマ4", "小テーマ5"],
                  "${selectedMainThemeTitles[4]}": ["小テーマ1", "小テーマ2", "小テーマ3", "小テーマ4", "小テーマ5"]
                }
            `;
            
            try {
                const subthemeData = await callGeminiApi(prompt); // {"テーマ1": [...], ...}

                subthemeResultsEl.innerHTML = ""; // 初期化
                finalThemesData = {}; // 最終データも初期化

                // selectedMainThemeTitles の順序を保持して構築する
                for (const themeTitle of selectedMainThemeTitles) {
                    const subthemes = subthemeData[themeTitle];
                    
                    if (!subthemes || !Array.isArray(subthemes) || subthemes.length === 0) {
                        throw new Error(`LLMが「${themeTitle}」に対する小テーマ（配列）を返しませんでした。`);
                    }
                    
                    finalThemesData[themeTitle] = {
                        title: themeTitle,
                        subthemes: subthemes
                    };
                    
                    const container = document.createElement('div');
                    container.className = 'subtheme-container';
                    
                    const title = document.createElement('h3');
                    title.textContent = themeTitle;
                    container.appendChild(title);
                    
                    const ul = document.createElement('ul');
                    ul.className = 'subtheme-list';
                    subthemes.forEach(sub => {
                        const li = document.createElement('li');
                        li.textContent = sub;
                        ul.appendChild(li);
                    });
                    container.appendChild(ul);
                    
                    subthemeResultsEl.appendChild(container);
                }
                
                showScreen('screen-subthemes');

            } catch (error) {
                // エラーが発生した画面に応じて表示
                if (document.getElementById('screen-themes').classList.contains('active')) {
                    showError(themesError, error.message);
                } else {
                    showError(subthemesError, error.message);
                }
            } finally {
                showLoading(false);
            }
        }

        /** ステップ3: 小テーマ再提案ボタン押下 */
        function retrySubthemes() {
            clearError(themesError, subthemesError);
            generateSubthemes(true); // true = 再提案
        }

        /** ステップ3: 大テーマ再選択ボタン押下 */
        function goBackToMainThemes() {
            clearError(themesError, subthemesError);
            // チェックボックスの状態をリセット
            const checkboxes = document.querySelectorAll('#theme-list input[type="checkbox"]');
            checkboxes.forEach(box => {
                box.checked = false;
                box.disabled = false;
            });
            handleCheckboxChange(); // 状態をリセット
            showScreen('screen-themes');
        }
        
        /** ステップ4: 最終決定ボタン押下 */
        function showFinalResult() {
            finalResultContainerEl.innerHTML = ""; // 初期化
            
            // subthemeResultsEl の内容をそのままクローンする（再構築の手間を省く）
            const resultsClone = subthemeResultsEl.cloneNode(true);
F            finalResultContainerEl.appendChild(resultsClone);
            
            showScreen('screen-final');
        }

        /** ステップ4: 最初からやり直す */
        function restartProcess() {
            // APIキーは保持する
            selectedMainThemeTitles = [];
            finalThemesData = {};
            clearError(startError, themesError, subthemesError);
            
            // スタート画面に戻る（APIキーは入力されたまま）
            showScreen('screen-start');
        }

        // --- イベントリスナーの初期設定 ---
        btnStart.addEventListener('click', startProcess);
        btnConfirmThemes.addEventListener('click', confirmMainThemes);
        btnRetrySubthemes.addEventListener('click', retrySubthemes);
        btnBackToMain.addEventListener('click', goBackToMainThemes);
        btnConfirmFinal.addEventListener('click', showFinalResult);
        btnRestart.addEventListener('click', restartProcess);

    </script>

</body>
</html>